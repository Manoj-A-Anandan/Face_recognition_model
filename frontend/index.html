<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Match My Guest</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
  :root {
    --primary: #6366f1;
    --primary-hover: #4f46e5;
    --secondary: #ec4899;
    --danger: #ef4444;
    --danger-hover: #dc2626;
    --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    --card-bg: #ffffff;
    --text-main: #1f2937;
    --text-light: #6b7280;
  }

  body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    padding: 0;
    background: var(--bg-gradient);
    min-height: 100vh;
    color: var(--text-main);
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .container {
    width: 90%;
    max-width: 900px;
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    padding: 40px;
    margin-top: 40px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    margin-bottom: 40px;
  }
  
  .hidden { display: none !important; }
  .fade-in { animation: fadeIn 0.4s ease-in-out; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; }
  .nav-title { font-weight: 700; font-size: 1.2rem; color: var(--text-main); }

  .btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: transform 0.2s; font-size: 0.95rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
  .btn:active { transform: scale(0.98); }
  .btn:disabled { background-color: #ccc !important; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
  .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
  
  .btn-primary { background: var(--primary); color: white; }
  .btn-secondary { background: var(--secondary); color: white; }
  .btn-outline { background: white; border: 1px solid #d1d5db; color: var(--text-main); }
  .btn-success { background: #10b981; color: white; }
  .btn-danger { background: var(--danger); color: white; }

  /* --- Icon Styles --- */
  .choice-container { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 30px; }
  .choice-card { background: #f9fafb; border: 2px solid transparent; border-radius: 12px; padding: 25px; width: 180px; cursor: pointer; transition: 0.3s; }
  .choice-card:hover { background: white; border-color: var(--primary); transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.05); }
  
  .choice-icon { display: flex; justify-content: center; margin-bottom: 15px; color: var(--primary); }
  .choice-icon svg { width: 48px; height: 48px; stroke-width: 2; stroke: currentColor; fill: none; stroke-linecap: round; stroke-linejoin: round; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
  .choice-card:hover .choice-icon svg { transform: scale(1.2) rotate(-5deg); stroke: var(--secondary); }

  .input-group { margin-bottom: 20px; text-align: left; position: relative; }
  label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 0.9rem; }
  input[type="text"], input[type="file"] { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; box-sizing: border-box; font-size: 1rem; }
  
  .suggestions-box { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e5e7eb; border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 50; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: none; }
  .suggestion-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f3f4f6; text-align: left; }
  .suggestion-item:hover { background-color: #f9fafb; color: var(--primary); }

  .event-list { max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; margin-top: 10px; text-align: left; }
  .event-item { padding: 12px 15px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 12px; cursor: pointer; }
  .event-item:hover { background: #f9fafb; }
  .event-item input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }
  .event-name { font-weight: 500; flex: 1; }

  .grid-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-top: 10px; }
  .match-card { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; background: white; }
  .match-card img { width: 100%; height: 160px; object-fit: cover; display: block; }
  .match-info { padding: 8px; font-size: 0.75rem; background: #f9fafb; text-align: left; }
  .score-high { color: #059669; font-weight: bold; } 
  
  .status-msg { margin-top: 15px; font-weight: 500; word-wrap: break-word; }
  .error { color: #ef4444; }
  .success { color: #059669; }
</style>
</head>
<body>

<div id="landingSection" class="container fade-in">
  <h1>Match My Guest</h1>
  <p>Organize your event photos or find yourself in seconds.</p>
  
  <div class="choice-container">
    <div class="choice-card" onclick="navTo('uploadSection')">
      <span class="choice-icon">
        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
      </span>
      <h3>Upload</h3>
      <span>Create event</span>
    </div>

    <div class="choice-card" onclick="navTo('querySection'); loadEventsForQuery();">
      <span class="choice-icon">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
      </span>
      <h3>Find Face</h3>
      <span>Search photos</span>
    </div>

    <div class="choice-card" onclick="navTo('deleteSection'); loadEventsForDelete();">
      <span class="choice-icon">
         <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
      </span>
      <h3>Manage</h3>
      <span>Delete events</span>
    </div>
  </div>
</div>

<div id="uploadSection" class="container hidden">
  <div class="nav-header">
    <button class="btn btn-outline btn-sm" onclick="navTo('landingSection')">Back Home</button>
    <span class="nav-title">Create Event</span>
    <div style="width:70px"></div>
  </div>
  <div id="uploadInputs">
      <div class="input-group">
        <label>Event Name</label>
        <input type="text" id="eventName" placeholder="e.g. Wedding_Reception (unique)">
        <div id="nameCheckStatus" style="font-size: 0.85rem; margin-top: 5px;"></div>
      </div>
      <div class="input-group">
        <label>Select Folder</label>
        <input type="file" id="folderInput" webkitdirectory directory multiple>
        <div id="fileCount" style="margin-top:5px; color:var(--primary); font-weight:bold;"></div>
      </div>
  </div>
  <button class="btn btn-primary" id="uploadBtn" style="width:100%" disabled>Start Upload & Processing</button>
  <div id="uploadStatus" class="status-msg"></div>
</div>

<div id="querySection" class="container hidden">
  <div class="nav-header">
    <button class="btn btn-outline btn-sm" onclick="navTo('landingSection')">Back Home</button>
    <span class="nav-title">Find Photos</span>
    <div style="width:70px"></div>
  </div>
  <div style="display:flex; gap:20px; flex-wrap:wrap;">
    <div class="input-group" style="flex:1; min-width:250px;">
      <label>Select Event</label>
      <input type="text" id="eventSearchInput" placeholder="Type to search event..." autocomplete="off">
      <div id="suggestions" class="suggestions-box"></div>
    </div>
    <div class="input-group" style="flex:1; min-width:250px;">
      <label>Your Selfie</label>
      <input type="file" id="queryImage" accept="image/*">
    </div>
  </div>
  <button class="btn btn-secondary" id="matchBtn" style="width:100%">Find Matches</button>
  <div id="matchStatus" class="status-msg"></div>
  <div id="resultsHeader" class="result-header hidden">
    <span id="resultsCount" style="font-weight:bold;"></span>
    <button class="btn btn-success btn-sm" id="downloadAllBtn">Download All (.zip)</button>
  </div>
  <div id="resultsArea" class="grid-results"></div>
</div>

<div id="deleteSection" class="container hidden">
  <div class="nav-header">
    <button class="btn btn-outline btn-sm" onclick="navTo('landingSection')">Back Home</button>
    <span class="nav-title">Manage Events</span>
    <div style="width:70px"></div>
  </div>
  <div class="input-group">
    <label>Search Events to Delete</label>
    <input type="text" id="deleteSearchInput" placeholder="Filter events...">
  </div>
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
    <span style="font-size:0.9rem; color:#666;" id="deleteListCount">Loading...</span>
    <button class="btn btn-outline btn-sm" id="selectAllBtn">Select All</button>
  </div>
  <div id="deleteList" class="event-list"></div>
  <div style="margin-top:20px;">
    <button class="btn btn-danger" id="deleteBtn" disabled>Delete Selected (0)</button>
  </div>
  <div id="deleteStatus" class="status-msg"></div>
</div>

<script>
  const API_BASE = "http://localhost:8000"; 
  let availableEvents = []; 
  let currentMatches = []; 
  let eventsToDeleteList = [];

  // --- NAVIGATION ---
  function navTo(sectionId) {
    document.querySelectorAll('.container').forEach(el => el.classList.add('hidden'));
    const el = document.getElementById(sectionId);
    el.classList.remove('hidden');
    el.classList.add('fade-in');
    setTimeout(() => el.classList.remove('fade-in'), 500);

    localStorage.setItem('lastPage', sectionId);
    if(sectionId === 'landingSection') localStorage.removeItem('lastPage');

    resetUploadPage();
    resetQueryPage();
    resetDeletePage();
  }

  window.addEventListener('load', () => {
    const lastPage = localStorage.getItem('lastPage');
    if(lastPage && document.getElementById(lastPage)) {
        navTo(lastPage);
        if(lastPage === 'querySection') loadEventsForQuery();
        if(lastPage === 'deleteSection') loadEventsForDelete();
    } else {
        navTo('landingSection');
    }
  });

  function resetUploadPage() {
    document.getElementById('eventName').value = "";
    document.getElementById('folderInput').value = "";
    document.getElementById('fileCount').textContent = "";
    document.getElementById('nameCheckStatus').textContent = "";
    document.getElementById('uploadStatus').innerHTML = "";
    document.getElementById('uploadBtn').disabled = true; 
    document.getElementById('uploadBtn').style.display = 'inline-flex';
    document.getElementById('uploadInputs').classList.remove('hidden'); 
  }

  function resetQueryPage() {
    document.getElementById('resultsArea').innerHTML = "";
    document.getElementById('resultsHeader').classList.add('hidden');
    document.getElementById('matchStatus').innerHTML = "";
    document.getElementById('eventSearchInput').value = "";
    document.getElementById('queryImage').value = "";
    document.getElementById('suggestions').innerHTML = "";
    currentMatches = [];
  }

  function resetDeletePage() {
    document.getElementById('deleteSearchInput').value = "";
    document.getElementById('deleteList').innerHTML = "";
    document.getElementById('deleteStatus').innerHTML = "";
    document.getElementById('deleteBtn').disabled = true;
    document.getElementById('deleteBtn').textContent = "Delete Selected (0)";
  }

  // --- UPLOAD (STRICT MODE) ---
  const eventNameInput = document.getElementById('eventName');
  const nameCheckStatus = document.getElementById('nameCheckStatus');
  const folderInput = document.getElementById('folderInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const uploadStatus = document.getElementById('uploadStatus');

  eventNameInput.addEventListener('input', () => {
    uploadBtn.disabled = true;
    nameCheckStatus.innerHTML = "";
  });

  eventNameInput.addEventListener('blur', async () => {
    const name = eventNameInput.value.trim();
    if(!name) { 
        nameCheckStatus.textContent = ""; 
        uploadBtn.disabled = true;
        return; 
    }
    try {
      const res = await fetch(`${API_BASE}/check-event-name?name=${name}`);
      const data = await res.json();
      if(data.exists) {
          nameCheckStatus.innerHTML = "<span class='error'>Event name taken. Choose another.</span>";
          uploadBtn.disabled = true; 
      } else {
          nameCheckStatus.innerHTML = "<span class='success'>Name available.</span>";
          if(folderInput.files.length > 0) uploadBtn.disabled = false;
          else uploadBtn.disabled = true;
      }
    } catch(e) { console.error(e); }
  });

  folderInput.addEventListener('change', () => {
    document.getElementById('fileCount').textContent = `${folderInput.files.length} files selected.`;
    if(nameCheckStatus.innerHTML.includes("available")) {
        uploadBtn.disabled = false;
    }
  });

  uploadBtn.addEventListener('click', async () => {
    const name = eventNameInput.value.trim();
    if(!name || nameCheckStatus.innerHTML.includes("taken")) return alert("Invalid event name.");
    if(!folderInput.files.length) return alert("Select a folder.");

    uploadBtn.disabled = true;
    uploadStatus.innerHTML = "Processing... please wait.";

    const formData = new FormData();
    formData.append("event_name", name);
    for (const file of folderInput.files) formData.append("files", file, file.name);

    try {
      const res = await fetch(`${API_BASE}/upload-folder`, { method: "POST", body: formData });
      if(!res.ok) {
          let errMsg = await res.text();
          try { 
            const jsonErr = JSON.parse(errMsg);
            if(jsonErr.detail) errMsg = jsonErr.detail;
          } catch(e){}
          throw new Error(errMsg);
      }
      const data = await res.json();
      
      document.getElementById('uploadInputs').classList.add('hidden');
      uploadBtn.style.display = 'none'; 

      uploadStatus.innerHTML = `
        <div style="background:#ecfdf5; padding:20px; border-radius:12px; border:1px solid #10b981; margin-top:15px;">
            <h3 style="color:#059669; margin:0 0 10px 0;">Event Created!</h3>
            <p style="color:#065f46; margin-bottom:15px;">Uploaded ${data.images_uploaded} images.<br>Found ${data.faces_found} faces.</p>
            <button class="btn btn-secondary" onclick="navTo('querySection'); loadEventsForQuery();">Go to Find Faces</button>
        </div>`;
    } catch(err) {
      uploadBtn.disabled = false;
      uploadStatus.innerHTML = `<span class="error">Error: ${err.message}</span>`;
    }
  });

  // --- QUERY ---
  async function loadEventsForQuery() {
    try {
      const res = await fetch(`${API_BASE}/list-events`);
      availableEvents = await res.json(); 
    } catch(e) { console.error(e); }
  }

  const eventSearchInput = document.getElementById('eventSearchInput');
  const suggestionsBox = document.getElementById('suggestions');

  eventSearchInput.addEventListener('input', () => {
    const val = eventSearchInput.value.toLowerCase().trim();
    suggestionsBox.innerHTML = '';
    if (!val) { suggestionsBox.style.display = 'none'; return; }
    const matches = availableEvents.filter(ev => ev.toLowerCase().includes(val));
    if(matches.length) {
      suggestionsBox.style.display = 'block';
      matches.forEach(ev => {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.textContent = ev;
        div.onclick = () => {
            eventSearchInput.value = ev;
            suggestionsBox.style.display = 'none';
        };
        suggestionsBox.appendChild(div);
      });
    } else { suggestionsBox.style.display = 'none'; }
  });

  document.addEventListener('click', (e) => {
    if (!eventSearchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
      suggestionsBox.style.display = 'none';
    }
  });

  document.getElementById('matchBtn').addEventListener('click', async () => {
    const eventName = eventSearchInput.value.trim();
    const fileInput = document.getElementById('queryImage');
    const resultsHeader = document.getElementById('resultsHeader');
    
    if(!eventName) return alert("Select an event.");
    if(!fileInput.files.length) return alert("Upload a selfie.");

    const statusDiv = document.getElementById('matchStatus');
    const resultsDiv = document.getElementById('resultsArea');
    
    statusDiv.innerHTML = "Searching faces...";
    resultsDiv.innerHTML = "";
    resultsHeader.classList.add('hidden');

    const formData = new FormData();
    formData.append("event_prefix", eventName);
    formData.append("file", fileInput.files[0]);
    formData.append("threshold", "0.45"); 
    formData.append("top_k", "200");

    try {
      const res = await fetch(`${API_BASE}/match-against-event`, { method: "POST", body: formData });
      if(!res.ok) {
          let errorMsg = await res.text();
          try {
              const jsonErr = JSON.parse(errorMsg);
              if(jsonErr.detail) errorMsg = jsonErr.detail;
          } catch(e) {} 
          if(errorMsg.includes("encodings not found")) throw new Error("Event not ready. Please delete and re-upload.");
          throw new Error(errorMsg);
      }

      const data = await res.json();
      currentMatches = data.matches; 
      statusDiv.innerHTML = "";

      if(!currentMatches.length) {
        resultsDiv.innerHTML = "<p>No matches found.</p>";
        return;
      }

      resultsHeader.classList.remove('hidden');
      document.getElementById('resultsCount').textContent = `Found ${currentMatches.length} Photos`;

      currentMatches.forEach(match => {
        const card = document.createElement('div');
        card.className = 'match-card';
        const niceName = match.object_name.split('/').pop();
        const pct = (match.score * 100).toFixed(0);
        card.innerHTML = `
          <a href="${match.signed_url}" target="_blank"><img src="${match.signed_url}" loading="lazy"></a>
          <div class="match-info"><span class="score-high">${pct}% Match</span> â€¢ ${niceName}</div>`;
        resultsDiv.appendChild(card);
      });
    } catch (err) {
      statusDiv.innerHTML = `<span class="error">${err.message}</span>`;
    }
  });

  document.getElementById('downloadAllBtn').addEventListener('click', async () => {
    if(!currentMatches.length) return;
    const btn = document.getElementById('downloadAllBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = "Zipping...";
    btn.disabled = true;
    try {
        const filePaths = currentMatches.map(m => m.object_name);
        const response = await fetch(`${API_BASE}/download-zip`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ files: filePaths })
        });
        if (!response.ok) throw new Error("Zip failed");
        const blob = await response.blob();
        saveAs(blob, "wedding_matches.zip");
    } catch(e) { alert("Error: " + e.message); } 
    finally { btn.innerHTML = originalText; btn.disabled = false; }
  });

  // --- DELETE ---
  const deleteSearchInput = document.getElementById('deleteSearchInput');
  const deleteList = document.getElementById('deleteList');
  const deleteBtn = document.getElementById('deleteBtn');
  const selectAllBtn = document.getElementById('selectAllBtn');

  async function loadEventsForDelete() {
    deleteList.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Loading...</div>';
    try {
      const res = await fetch(`${API_BASE}/list-events`);
      eventsToDeleteList = await res.json();
      renderDeleteList(eventsToDeleteList);
    } catch(e) { deleteList.innerHTML = '<div style="padding:20px; color:red;">Failed to load</div>'; }
  }

  function renderDeleteList(events) {
    deleteList.innerHTML = "";
    document.getElementById('deleteListCount').textContent = `${events.length} events found`;
    if(events.length === 0) {
        deleteList.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">No events found.</div>';
        return;
    }
    events.forEach(ev => {
        const div = document.createElement('div');
        div.className = 'event-item';
        div.innerHTML = `<input type="checkbox" class="delete-checkbox" value="${ev}/"><div class="event-name">${ev.replace('event_', '')}</div>`;
        div.addEventListener('click', (e) => {
            if(e.target.type !== 'checkbox') {
                const cb = div.querySelector('input[type="checkbox"]');
                cb.checked = !cb.checked;
                updateDeleteBtn();
            }
        });
        div.querySelector('input').addEventListener('change', updateDeleteBtn);
        deleteList.appendChild(div);
    });
    updateDeleteBtn();
  }

  deleteSearchInput.addEventListener('input', () => {
    const val = deleteSearchInput.value.toLowerCase();
    renderDeleteList(eventsToDeleteList.filter(ev => ev.toLowerCase().includes(val)));
  });

  function updateDeleteBtn() {
    const count = document.querySelectorAll('.delete-checkbox:checked').length;
    deleteBtn.disabled = count === 0;
    deleteBtn.textContent = `Delete Selected (${count})`;
  }

  selectAllBtn.addEventListener('click', () => {
    const checkboxes = document.querySelectorAll('.delete-checkbox');
    const allChecked = Array.from(checkboxes).every(c => c.checked);
    checkboxes.forEach(cb => cb.checked = !allChecked);
    updateDeleteBtn();
  });

  deleteBtn.addEventListener('click', async () => {
    const prefixes = Array.from(document.querySelectorAll('.delete-checkbox:checked')).map(cb => cb.value);
    if(!confirm(`Permanently delete ${prefixes.length} events? This cannot be undone.`)) return;
    
    const status = document.getElementById('deleteStatus');
    status.innerHTML = "Deleting files...";
    deleteBtn.disabled = true;
    
    try {
        const res = await fetch(`${API_BASE}/delete-events`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ event_prefixes: prefixes })
        });
        const data = await res.json();
        status.innerHTML = `<span class="success">^_^ Deleted ${data.deleted} events.</span>`;
        
        document.getElementById('deleteList').innerHTML = "";
        document.getElementById('deleteListCount').textContent = "Refreshing...";
        deleteBtn.textContent = "Delete Selected (0)";
        
        setTimeout(() => { loadEventsForDelete(); status.innerHTML = ""; }, 1000);
    } catch(e) {
        status.innerHTML = `<span class="error">Error: ${e.message}</span>`;
        deleteBtn.disabled = false;
    }
  });
</script>
</body>
</html>